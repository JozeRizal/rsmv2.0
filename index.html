<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadhan Slide Maker (AI)</title>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@400;700&family=Lato:wght@300;400;700&family=Merriweather:wght@300;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Oswald:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Poppins:wght@300;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: { 700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22' },
                        gold: { 300: '#FDE68A', 400: '#E6C25F', 500: '#D4AF37', 600: '#B5942D' }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        .islamic-pattern {
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23D4AF37' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .slide-aspect { aspect-ratio: 16 / 9; }
        
        [contenteditable="true"]:focus { 
            outline: 2px dashed #D4AF37; 
            background-color: rgba(212, 175, 55, 0.1); 
            border-radius: 4px; padding: 2px; position: relative; z-index: 50; 
        }

        /* --- CUSTOM SCROLLBAR UNTUK SLIDE --- */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5); /* Warna abu-abu transparan */
            border-radius: 20px;
        }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background-color: rgba(107, 114, 128, 0.8);
        }
        
        /* SIDEBAR TOOLBAR */
        .slide-toolbar { opacity: 0; transition: opacity 0.2s ease-in-out; right: -60px; width: 50px; }
        .slide-wrapper:hover .slide-toolbar { opacity: 1; }
        
        .sidebar-btn {
            width: 36px; height: 36px; border-radius: 50%; background: white; color: #4b5563;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;
            cursor: pointer; transition: all 0.2s; font-size: 14px; pointer-events: auto;
        }
        .sidebar-btn:hover { background: #f3f4f6; transform: scale(1.05); }
        .sidebar-btn.danger { color: #dc2626; border-color: #fecaca; }
        .sidebar-btn.danger:hover { background: #fef2f2; }
        
        /* --- IMAGE CONTAINER SYSTEM --- */
        .img-container {
            position: relative;
            z-index: 30; 
            cursor: pointer;
            border: 2px solid transparent; 
            transition: border-color 0.2s;
        }
        
        .img-container.active-selection {
            border-color: #3b82f6; 
            z-index: 100; 
        }

        .img-container.active-selection img {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Layout Modes */
        .img-container.mode-left { float: left; margin-right: 1.5rem; margin-bottom: 1rem; }
        .img-container.mode-right { float: right; margin-left: 1.5rem; margin-bottom: 1rem; }
        .img-container.mode-center { display: block; margin-left: auto; margin-right: auto; margin-bottom: 1rem; clear: both; }
        .img-container.mode-free { position: absolute; }

        /* --- TOOLBAR (L/C/R/Free) --- */
        .action-toolbar {
            position: absolute;
            bottom: -40px; left: 50%; transform: translateX(-50%);
            background: #1f2937;
            padding: 4px;
            border-radius: 6px;
            display: none; 
            gap: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 200;
            white-space: nowrap;
        }
        
        .img-container.active-selection .action-toolbar { display: flex; }

        .tool-btn {
            color: white; font-size: 10px; font-weight: bold;
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
        }
        .tool-btn:hover { background: rgba(255,255,255,0.2); }
        .tool-btn.active-mode { background: #059669; border-color: #059669; }
        .tool-btn.delete { background: #dc2626; border-color: #dc2626; }

        /* --- RESIZE HANDLE --- */
        .resize-dot {
            width: 16px; height: 16px;
            background: #D4AF37;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: -8px; right: -8px;
            cursor: nwse-resize;
            z-index: 201;
            display: none; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .img-container.active-selection .resize-dot { display: block; }

        /* TEXT TOOLBAR */
        #textToolbar {
            position: absolute; background: #1f2937; border-radius: 8px; padding: 6px; display: none; gap: 6px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 999; align-items: center;
            transform: translateY(-100%); margin-top: -10px; border: 1px solid #374151;
        }
        #textToolbar::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            border-width: 6px 6px 0; border-style: solid; border-color: #1f2937 transparent transparent transparent;
        }
        .text-btn { color: #d1d5db; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .text-btn:hover { background: #374151; color: white; }
        .text-select { background: #374151; color: white; border: none; font-size: 12px; padding: 4px; border-radius: 4px; outline: none; cursor: pointer; max-width: 100px; }
        .text-color-input { width: 24px; height: 24px; border: none; background: transparent; cursor: pointer; }
        .separator { width: 1px; height: 16px; background: #4b5563; margin: 0 4px; }
        
        .layer-bg { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
        .bg-control-panel { background: white; padding: 8px; border-radius: 8px; margin-top: 8px; font-size: 10px; text-align: center; pointer-events: auto; z-index: 50; position: relative;}
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col md:flex-row font-sans">

    <!-- FLOATING TEXT TOOLBAR -->
    <div id="textToolbar" data-html2canvas-ignore="true">
        <select id="fontFamilySelect" class="text-select" onchange="execCmd('fontName', this.value)">
            <option value="Lato">Lato</option>
            <option value="Playfair Display">Playfair</option>
            <option value="Roboto">Roboto</option>
            <option value="Open Sans">Open Sans</option>
            <option value="Montserrat">Montserrat</option>
            <option value="Merriweather">Merriweather</option>
            <option value="Poppins">Poppins</option>
            <option value="Dancing Script">Dancing Script</option>
            <option value="Amiri">Amiri (Arab)</option>
            <option value="Oswald">Oswald</option>
        </select>
        <div class="separator"></div>
        <button class="text-btn font-bold" onmousedown="event.preventDefault(); execCmd('bold')">B</button>
        <button class="text-btn italic" onmousedown="event.preventDefault(); execCmd('italic')">I</button>
        <button class="text-btn underline" onmousedown="event.preventDefault(); execCmd('underline')">U</button>
        <button class="text-btn line-through" onmousedown="event.preventDefault(); execCmd('strikeThrough')">S</button>
        <div class="separator"></div>
        <button class="text-btn" onmousedown="event.preventDefault(); execCmd('fontSize', '3')">A</button>
        <button class="text-btn text-lg" onmousedown="event.preventDefault(); execCmd('fontSize', '5')">A+</button>
        <button class="text-btn text-xl" onmousedown="event.preventDefault(); execCmd('fontSize', '7')">A++</button>
        <div class="separator"></div>
        <input type="color" id="foreColorInput" class="text-color-input" oninput="execCmd('foreColor', this.value)">
    </div>

    <!-- HIDDEN INPUTS -->
    <input type="file" id="imageUploader" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
    <input type="file" id="bgUploader" accept="image/*" class="hidden" onchange="handleBgUpload(event)">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-1/3 lg:w-1/4 bg-emerald-950 text-white flex flex-col h-full shadow-2xl z-20 border-r border-emerald-900">
        <div class="p-6 border-b border-emerald-900 bg-emerald-900/50">
            <h1 class="text-3xl font-serif text-gold-500 font-bold mb-1 leading-tight">Ramadhan Slide Maker</h1>
            <p class="text-xs text-emerald-300 uppercase tracking-widest mt-1">AI Presentation Tool</p>
        </div>
        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- API KEY INPUT -->
            <div class="space-y-2 pb-4 border-b border-emerald-800/50">
                <label class="text-xs font-bold text-gold-400 uppercase tracking-wide flex justify-between items-center">
                    Google Gemini API Key
                    <span class="text-[10px] text-emerald-400 font-normal normal-case opacity-70">Wajib diisi</span>
                </label>
                <div class="relative">
                    <input type="password" id="apiKeyInput" placeholder="Tempel API Key disini..." class="w-full bg-emerald-950 border border-emerald-700 rounded-lg p-3 pr-10 text-white focus:ring-2 focus:ring-gold-500 text-sm font-mono" onchange="saveApiKey(this.value)">
                    <button onclick="toggleApiKeyVisibility()" class="absolute right-3 top-3 text-emerald-500 hover:text-emerald-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <p class="text-[10px] text-emerald-400/60 leading-tight">Key tersimpan otomatis di browser lokal Anda. Tidak dikirim ke server kami.</p>
            </div>

            <div class="space-y-2">
                <label class="text-xs font-bold text-emerald-200 uppercase tracking-wide">Topik</label>
                <input type="text" id="topicInput" placeholder="Contoh: Keutamaan Ramadan" class="w-full bg-emerald-900/80 border border-emerald-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-gold-500" oninput="debounceSave()">
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-emerald-200 uppercase tracking-wide">Pembicara</label>
                <input type="text" id="speakerInput" placeholder="Contoh: Ustadz Ahmad" class="w-full bg-emerald-900/80 border border-emerald-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-gold-500" oninput="debounceSave()">
            </div>
             <div class="space-y-2">
                <label class="text-xs font-bold text-emerald-200 uppercase tracking-wide">Jumlah Slide</label>
                <select id="slideCountInput" class="w-full bg-emerald-900/80 border border-emerald-700 rounded-lg p-3 text-white cursor-pointer" onchange="saveWork()">
                    <option value="5">5 Slide</option>
                    <option value="7">7 Slide</option>
                    <option value="10">10 Slide</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-emerald-200 uppercase tracking-wide">Gaya Bahasa</label>
                <select id="toneInput" class="w-full bg-emerald-900/80 border border-emerald-700 rounded-lg p-3 text-white cursor-pointer" onchange="saveWork()">
                    <option value="khidmat">Khidmat & Menyentuh Hati (Muhasabah Style)</option>
                    <option value="semangat">Semangat & Membakar Jiwa (Motivational Style)</option>
                    <option value="santai">Santai & Kekinian (Gen Z / Medsos Style)</option>
                    <option value="formal">Formal & Akademis (Ustadz / Kajian Style)</option>
                    <option value="ceria">Ceria & Anak-anak (Storytelling Style)</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-emerald-200 uppercase tracking-wide">Tema Visual</label>
                <select id="styleInput" class="w-full bg-emerald-900/80 border border-emerald-700 rounded-lg p-3 text-white cursor-pointer" onchange="renderSlides(slidesData); saveWork()">
                    <optgroup label="Klasik">
                        <option value="luxury">Mewah Islami</option>
                        <option value="minimal">Minimalis</option>
                        <option value="dark">Malam Elegan</option>
                    </optgroup>
                    <optgroup label="Premium">
                        <option value="midnight">Midnight Blue</option>
                        <option value="sahara">Desert Warmth</option>
                        <option value="royal">Royal Purple</option>
                        <option value="jannah">Emerald Garden</option>
                        <option value="iftar">Sunset Gradient</option>
                    </optgroup>
                    <optgroup label="Spesial Ornamen (Eksklusif)">
                        <option value="ornament_night">Gema Takbir (Night Skyline)</option>
                        <option value="ornament_sunset">Cahaya Fanoos (Sunset Lanterns)</option>
                        <option value="ornament_green">Kubah Emerald (Geometric)</option>
                        <option value="ornament_lapis">Lapis Lazuli (Persian Night)</option>
                        <option value="ornament_gold_silk">Golden Silk (Sutra Emas)</option>
                        <option value="ornament_desert">Desert Mirage (Fatamorgana)</option>
                        <option value="ornament_ray">Divine Ray (Cahaya Ilahi)</option>
                        <option value="ornament_velvet">Velvet Moon (Bulan Beludru)</option>
                    </optgroup>
                </select>
            </div>
        </div>
        <div class="p-6 bg-emerald-950 border-t border-emerald-900 space-y-3">
            <button onclick="generateSlides()" id="generateBtn" class="w-full bg-gradient-to-r from-gold-500 to-gold-600 hover:from-gold-400 text-emerald-950 font-bold py-3.5 px-4 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">Buat Slide AI</button>
            <button onclick="downloadPDF()" id="downloadBtn" disabled class="w-full border border-emerald-700 text-emerald-300 hover:bg-emerald-900/50 py-3 rounded-lg disabled:opacity-50">Ekspor PDF</button>
            <button onclick="resetWork()" id="resetBtn" class="w-full border border-red-700 text-red-400 hover:bg-red-900/30 py-3 rounded-lg mt-2 transition text-sm">Reset / Mulai Ulang</button>
        </div>
    </aside>

    <!-- PREVIEW AREA -->
    <main class="flex-1 h-full overflow-hidden flex flex-col bg-gray-100 relative" 
          onmousedown="handleCanvasClick(event)"
          onmousemove="handleGlobalMouseMove(event)"
          onmouseup="handleGlobalMouseUp(event)">
          
        <div class="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-30 relative">
            <h2 class="text-gray-600 font-bold">Pratinjau Slide</h2>
            <div id="saveIndicator" class="text-xs text-gray-400 italic hidden">Tersimpan otomatis</div>
        </div>
        
        <div id="slideContainer" class="flex-1 overflow-y-auto pl-8 pr-28 py-8 space-y-12 flex flex-col items-center islamic-pattern pb-32 relative z-10"></div>
        
        <div id="loader" class="absolute top-16 inset-x-0 bottom-0 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center z-50 hidden">
            <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-emerald-800 font-bold animate-pulse">Sedang Meracik Konten...</p>
        </div>
    </main>

    <script>
        // --- DATA & STATE ---
        let slidesData = [];
        let currentUploadIdx = -1;
        let currentBgUploadIdx = -1;

        let activeSelection = null;
        let dragMode = null; 
        let dragTarget = null; 
        let dragStartData = {}; 

        // --- INIT API KEY & LOCAL STORAGE ---
        window.onload = function() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
            }
            loadWork();
        };

        function saveApiKey(val) {
            localStorage.setItem('gemini_api_key', val);
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function getApiKey() {
            return document.getElementById('apiKeyInput').value.trim();
        }

        // --- STORAGE FUNCTIONS ---
        let saveTimer;
        function debounceSave() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(saveWork, 1000); // Tunggu 1 detik sebelum simpan
        }

        function saveWork() {
            try {
                localStorage.setItem('ramadan_topic', document.getElementById('topicInput').value);
                localStorage.setItem('ramadan_speaker', document.getElementById('speakerInput').value);
                localStorage.setItem('ramadan_count', document.getElementById('slideCountInput').value);
                localStorage.setItem('ramadan_tone', document.getElementById('toneInput').value);
                localStorage.setItem('ramadan_style', document.getElementById('styleInput').value);
                localStorage.setItem('ramadan_slides', JSON.stringify(slidesData));
                
                // Show simple save indicator
                const indicator = document.getElementById('saveIndicator');
                if(indicator) {
                    indicator.classList.remove('hidden');
                    setTimeout(() => indicator.classList.add('hidden'), 2000);
                }
            } catch (e) {
                console.warn("Penyimpanan penuh atau error:", e);
            }
        }

        function loadWork() {
            if(localStorage.getItem('ramadan_topic')) document.getElementById('topicInput').value = localStorage.getItem('ramadan_topic');
            if(localStorage.getItem('ramadan_speaker')) document.getElementById('speakerInput').value = localStorage.getItem('ramadan_speaker');
            if(localStorage.getItem('ramadan_count')) document.getElementById('slideCountInput').value = localStorage.getItem('ramadan_count');
            if(localStorage.getItem('ramadan_tone')) document.getElementById('toneInput').value = localStorage.getItem('ramadan_tone');
            if(localStorage.getItem('ramadan_style')) document.getElementById('styleInput').value = localStorage.getItem('ramadan_style');
            
            const savedSlides = localStorage.getItem('ramadan_slides');
            if(savedSlides) {
                try {
                    slidesData = JSON.parse(savedSlides);
                    if(slidesData.length > 0) {
                        renderSlides(slidesData);
                        document.getElementById('downloadBtn').disabled = false;
                    }
                } catch(e) {
                    console.error("Gagal memuat slide tersimpan:", e);
                }
            }
        }

        function resetWork() {
            if(confirm("Apakah Anda yakin ingin menghapus semua pekerjaan dan memulai dari awal? Data yang tersimpan akan hilang.")) {
                localStorage.removeItem('ramadan_topic');
                localStorage.removeItem('ramadan_speaker');
                localStorage.removeItem('ramadan_count');
                localStorage.removeItem('ramadan_tone');
                localStorage.removeItem('ramadan_style');
                localStorage.removeItem('ramadan_slides');
                // Kita tidak menghapus API key agar user tidak perlu input ulang
                location.reload();
            }
        }

        // --- MANAJEMEN SELEKSI ---

        function handleCanvasClick(e) {
            if (dragMode) return;

            const target = e.target;
            
            if (target.classList.contains('tool-btn')) {
                e.stopPropagation(); 
                const action = target.dataset.action;
                const container = target.closest('.img-container');
                const sIdx = parseInt(container.dataset.sidx);
                const iIdx = parseInt(container.dataset.iidx);
                
                if (action === 'delete') {
                    deleteImg(sIdx, iIdx);
                } else {
                    changeLayout(sIdx, iIdx, action);
                }
                return;
            }

            if (target.classList.contains('resize-dot')) {
                e.preventDefault();
                e.stopPropagation();
                startInteraction(e, 'resize', target.closest('.img-container'));
                return;
            }

            const container = target.closest('.img-container');
            if (container) {
                e.stopPropagation();
                const isFree = container.classList.contains('mode-free');
                setActiveSelection(parseInt(container.dataset.sidx), parseInt(container.dataset.iidx));
                if (isFree) {
                    startInteraction(e, 'move', container);
                }
                return;
            }

            if (!target.closest('.img-container') && !target.closest('.tool-btn')) {
                clearSelection();
            }
        }

        function setActiveSelection(sIdx, iIdx) {
            activeSelection = { sIdx, iIdx };
            document.querySelectorAll('.img-container').forEach(el => {
                const elS = parseInt(el.dataset.sidx);
                const elI = parseInt(el.dataset.iidx);
                if (elS === sIdx && elI === iIdx) {
                    el.classList.add('active-selection');
                } else {
                    el.classList.remove('active-selection');
                }
            });
        }

        function clearSelection() {
            activeSelection = null;
            document.querySelectorAll('.img-container').forEach(el => el.classList.remove('active-selection'));
        }

        function startInteraction(e, mode, element) {
            dragMode = mode;
            dragTarget = element;
            
            dragStartData = {
                x: element.offsetLeft, 
                y: element.offsetTop,
                w: element.offsetWidth,
                mx: e.clientX,
                my: e.clientY
            };
        }

        function handleGlobalMouseMove(e) {
            if (!dragMode || !dragTarget) return;
            e.preventDefault();

            const dx = e.clientX - dragStartData.mx;
            const dy = e.clientY - dragStartData.my;

            if (dragMode === 'move') {
                dragTarget.style.left = (dragStartData.x + dx) + 'px';
                dragTarget.style.top = (dragStartData.y + dy) + 'px';
            } else if (dragMode === 'resize') {
                const newWidth = Math.max(50, dragStartData.w + dx);
                dragTarget.style.width = newWidth + 'px';
            }
        }

        function handleGlobalMouseUp(e) {
            if (!dragMode || !dragTarget) return;

            const sIdx = parseInt(dragTarget.dataset.sidx);
            const iIdx = parseInt(dragTarget.dataset.iidx);
            
            if (slidesData[sIdx] && slidesData[sIdx].images[iIdx]) {
                const imgData = slidesData[sIdx].images[iIdx];
                
                if (dragMode === 'move') {
                    imgData.x = parseFloat(dragTarget.style.left);
                    imgData.y = parseFloat(dragTarget.style.top);
                } else if (dragMode === 'resize') {
                    imgData.width = dragTarget.style.width;
                }
            }
            dragMode = null;
            dragTarget = null;
            saveWork(); // Simpan setelah resize/move
        }

        function changeLayout(sIdx, iIdx, layout) {
            if (!slidesData[sIdx].images[iIdx]) return;
            slidesData[sIdx].images[iIdx].layout = layout;
            if (layout === 'free' && !slidesData[sIdx].images[iIdx].x) {
                slidesData[sIdx].images[iIdx].x = 100;
                slidesData[sIdx].images[iIdx].y = 100;
            }
            activeSelection = { sIdx, iIdx };
            renderSlides(slidesData);
            saveWork();
        }

        function deleteImg(sIdx, iIdx) {
            slidesData[sIdx].images.splice(iIdx, 1);
            activeSelection = null;
            renderSlides(slidesData);
            saveWork();
        }

        function renderSlides(data) {
            const container = document.getElementById('slideContainer');
            const style = document.getElementById('styleInput').value;
            
            // --- PREMIUM SVG ASSETS (ENCODED FOR STABILITY) ---

            const mosqueSkylineSVG = "data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 1440 320%27%3E%3Cpath fill=%27%23111827%27 fill-opacity=%270.6%27 d=%27M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,250.7C960,235,1056,181,1152,165.3C1248,149,1344,171,1392,181.3L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z%27%3E%3C/path%3E%3Cpath fill=%27%23000000%27 fill-opacity=%270.8%27 d=%27M220,320 L220,200 L250,150 L280,200 L280,320 M500,320 L500,180 C500,140 580,140 580,180 L580,320 M850,320 L850,220 L870,220 L870,320 M1100,320 L1100,200 A50,50 0 0,1 1200,200 L1200,320%27/%3E%3C/svg%3E";
            
            const hangingLanternsSVG = "data:image/svg+xml,%3Csvg width=%27800%27 height=%27200%27 viewBox=%270 0 800 200%27 xmlns=%27http://www.w3.org/2000/svg%27%3E%3Cg fill=%27%2378350f%27 stroke=%27%2378350f%27%3E%3Cline x1=%27100%27 y1=%270%27 x2=%27100%27 y2=%27100%27 stroke-width=%272%27/%3E%3Crect x=%2785%27 y=%27100%27 width=%2730%27 height=%2750%27 rx=%275%27/%3E%3Ccircle cx=%27100%27 cy=%27125%27 r=%278%27 fill=%27%23fbbf24%27/%3E%3Cline x1=%27300%27 y1=%270%27 x2=%27300%27 y2=%2760%27 stroke-width=%272%27/%3E%3Crect x=%27290%27 y=%2760%27 width=%2720%27 height=%2730%27 rx=%273%27/%3E%3Ccircle cx=%27300%27 cy=%2775%27 r=%275%27 fill=%27%23fbbf24%27/%3E%3Cline x1=%27500%27 y1=%270%27 x2=%27500%27 y2=%27120%27 stroke-width=%272%27/%3E%3Crect x=%27480%27 y=%27120%27 width=%2740%27 height=%2760%27 rx=%275%27/%3E%3Ccircle cx=%27500%27 cy=%27150%27 r=%2710%27 fill=%27%23fbbf24%27/%3E%3Cline x1=%27700%27 y1=%270%27 x2=%27700%27 y2=%2780%27 stroke-width=%272%27/%3E%3Crect x=%27685%27 y=%2780%27 width=%2730%27 height=%2740%27 rx=%274%27/%3E%3Ccircle cx=%27700%27 cy=%27100%27 r=%276%27 fill=%27%23fbbf24%27/%3E%3C/g%3E%3C/svg%3E";
            
            const geoPatternSVG = "data:image/svg+xml,%3Csvg width=%2740%27 height=%2740%27 viewBox=%270 0 40 40%27 xmlns=%27http://www.w3.org/2000/svg%27%3E%3Cpath d=%27M20 0 L40 20 L20 40 L0 20 Z%27 fill=%27none%27 stroke=%27%2334d399%27 stroke-width=%270.5%27 opacity=%270.3%27/%3E%3Ccircle cx=%2720%27 cy=%2720%27 r=%278%27 fill=%27none%27 stroke=%27%2334d399%27 stroke-width=%270.5%27 opacity=%270.3%27/%3E%3C/svg%3E";

            // 1. Lapis Lazuli Pattern
            const lapisPatternSVG = "data:image/svg+xml,%3Csvg width=%2760%27 height=%2760%27 viewBox=%270 0 60 60%27 xmlns=%27http://www.w3.org/2000/svg%27%3E%3Cg fill=%27none%27 fill-rule=%27evenodd%27%3E%3Cg fill=%27%23eab308%27 fill-opacity=%270.1%27%3E%3Cpath d=%27M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6z%27/%3E%3C/g%3E%3C/g%3E%3C/svg%3E";

            // 2. Golden Silk Mandala Corner
            const goldMandalaSVG = "data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27400%27 height=%27400%27 viewBox=%270 0 400 400%27%3E%3Cpath fill=%27%23b45309%27 fill-opacity=%270.2%27 d=%27M0,0 L200,0 C100,0 0,100 0,200 Z%27/%3E%3Ccircle cx=%270%27 cy=%270%27 r=%27150%27 fill=%27none%27 stroke=%27%23d97706%27 stroke-width=%272%27 stroke-dasharray=%275,5%27 opacity=%270.5%27/%3E%3Cpath fill=%27none%27 stroke=%27%23d97706%27 stroke-width=%271%27 d=%27M0,0 L300,0 M0,0 L0,300%27 opacity=%270.3%27/%3E%3C/svg%3E";

            // 3. Desert Mirage Dunes
            const dunesSVG = "data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 1440 320%27%3E%3Cpath fill=%27%23a16207%27 fill-opacity=%270.4%27 d=%27M0,256L48,245.3C96,235,192,213,288,218.7C384,224,480,256,576,245.3C672,235,768,181,864,170.7C960,160,1056,192,1152,197.3C1248,203,1344,181,1392,170.7L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z%27%3E%3C/path%3E%3Cpath fill=%27%23713f12%27 fill-opacity=%270.6%27 d=%27M0,288L60,277.3C120,267,240,245,360,250.7C480,256,600,288,720,277.3C840,267,960,213,1080,202.7C1200,192,1320,224,1380,240L1440,256L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z%27%3E%3C/path%3E%3C/svg%3E";

            // 4. Divine Ray (Light Beams)
            const raysSVG = "data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27800%27 height=%27600%27 viewBox=%270 0 800 600%27%3E%3Cdefs%3E%3CradialGradient id=%27grad1%27 cx=%2750%25%27 cy=%270%25%27 r=%2770%25%27%3E%3Cstop offset=%270%25%27 style=%27stop-color:white;stop-opacity:0.2%27 /%3E%3Cstop offset=%27100%25%27 style=%27stop-color:white;stop-opacity:0%27 /%3E%3C/radialGradient%3E%3C/defs%3E%3Cpath d=%27M350,0 L450,0 L550,600 L250,600 Z%27 fill=%27url(%23grad1)%27 opacity=%270.5%27/%3E%3C/svg%3E";
            
            // 5. Velvet Moon Watermark
            const bigMoonSVG = "data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 200 200%27%3E%3Cpath fill=%27%23ffffff%27 fill-opacity=%270.05%27 d=%27M100,20 A80,80 0 1,0 100,180 A60,60 0 1,1 100,20 Z%27/%3E%3C/svg%3E";


            const themes = {
                // Existing
                luxury: { bg: "bg-stone-50", text: "text-emerald-950", accent: "text-gold-600", deco: "bg-gold-500", border: "border-gold-500" },
                minimal: { bg: "bg-white", text: "text-gray-800", accent: "text-emerald-600", deco: "bg-emerald-600", border: "border-gray-200" },
                dark: { bg: "bg-emerald-950", text: "text-white", accent: "text-gold-400", deco: "bg-gold-400", border: "border-emerald-800" },
                midnight: { bg: "bg-slate-900", text: "text-blue-50", accent: "text-cyan-400", deco: "bg-cyan-500", border: "border-cyan-900" },
                sahara: { bg: "bg-orange-50", text: "text-amber-950", accent: "text-orange-600", deco: "bg-orange-500", border: "border-orange-200" },
                royal: { bg: "bg-purple-900", text: "text-purple-50", accent: "text-amber-300", deco: "bg-amber-400", border: "border-purple-700" },
                jannah: { bg: "bg-teal-50", text: "text-teal-900", accent: "text-emerald-600", deco: "bg-emerald-500", border: "border-teal-200" },
                iftar: { bg: "bg-rose-50", text: "text-rose-950", accent: "text-rose-600", deco: "bg-rose-500", border: "border-rose-200" },
                
                // --- KATEGORI SPESIAL ORNAMEN (PREMIUM + DYNAMIC) ---
                
                // 1. Gema Takbir (Night Skyline) - Asymmetric bottom heavy
                ornament_night: { 
                    bg: "bg-slate-900", 
                    customStyle: `background: url('${mosqueSkylineSVG}') bottom center repeat-x, linear-gradient(135deg, #0f172a 0%, #312e81 100%); background-size: 100% auto, cover; background-blend-mode: overlay;`,
                    text: "text-blue-50", accent: "text-yellow-400", deco: "bg-yellow-400", border: "border-blue-800" 
                },
                // 2. Cahaya Fanoos (Sunset Lanterns) - Asymmetric top heavy
                ornament_sunset: { 
                    bg: "bg-orange-50", 
                    customStyle: `background: url('${hangingLanternsSVG}') top left repeat-x, linear-gradient(180deg, #fff7ed 0%, #fed7aa 100%); background-size: auto 180px, cover;`,
                    text: "text-amber-900", accent: "text-orange-600", deco: "bg-orange-500", border: "border-amber-900" 
                },
                // 3. Kubah Emerald (Geometric) - Center Radial focus
                ornament_green: { 
                    bg: "bg-emerald-900", 
                    customStyle: `background: url('${geoPatternSVG}'), radial-gradient(circle at 50% 50%, #10b981 0%, #064e3b 80%); background-size: 100px 100px, cover; background-blend-mode: soft-light;`,
                    text: "text-emerald-50", accent: "text-emerald-300", deco: "bg-emerald-400", border: "border-emerald-600" 
                },

                // --- 5 TEMA BARU (HIGH VALUE) ---

                // 4. Lapis Lazuli (Persian Night) - Vibrant Blue/Gold, Tiled pattern subtle
                ornament_lapis: {
                    bg: "bg-blue-900",
                    customStyle: `background: url('${lapisPatternSVG}'), linear-gradient(135deg, #1e3a8a 0%, #172554 100%); background-size: 60px 60px, cover; background-blend-mode: overlay;`,
                    text: "text-yellow-50", accent: "text-yellow-400", deco: "bg-yellow-500", border: "border-yellow-600"
                },
                // 5. Golden Silk (Sutra Emas) - Clean, Minimalist Luxury, Corner ornaments
                ornament_gold_silk: {
                    bg: "bg-stone-50",
                    customStyle: `background: url('${goldMandalaSVG}') top right no-repeat, url('${goldMandalaSVG}') bottom left no-repeat, linear-gradient(to bottom right, #fafaf9, #f5f5f4); background-size: 250px 250px, 250px 250px, cover; transform: rotate(0deg);`, 
                    text: "text-stone-800", accent: "text-amber-600", deco: "bg-amber-500", border: "border-amber-300"
                },
                // 6. Desert Mirage (Fatamorgana) - Warm, Organic curves at bottom
                ornament_desert: {
                    bg: "bg-orange-100",
                    customStyle: `background: url('${dunesSVG}') bottom center no-repeat, linear-gradient(180deg, #ffedd5 0%, #fb923c 100%); background-size: 100% auto, cover;`,
                    text: "text-amber-950", accent: "text-orange-800", deco: "bg-orange-700", border: "border-orange-300"
                },
                // 7. Divine Ray (Cahaya Ilahi) - Asymmetric lighting from top center
                ornament_ray: {
                    bg: "bg-teal-950",
                    customStyle: `background: url('${raysSVG}') top center no-repeat, linear-gradient(to bottom, #115e59, #042f2e); background-size: 100% 80%, cover; background-blend-mode: screen;`,
                    text: "text-teal-50", accent: "text-teal-200", deco: "bg-teal-400", border: "border-teal-600"
                },
                // 8. Velvet Moon (Bulan Beludru) - Deep Maroon, Big Watermark
                ornament_velvet: {
                    bg: "bg-red-950",
                    customStyle: `background: url('${bigMoonSVG}') center right no-repeat, linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%); background-size: 80% 80%, cover;`,
                    text: "text-rose-50", accent: "text-rose-300", deco: "bg-rose-500", border: "border-rose-800"
                }
            };
            const th = themes[style] || themes.luxury;
            
            container.innerHTML = data.map((slide, i) => {
                const align = slide.align || 'text-left';
                
                let bgLayer = '';
                let bgControls = '';
                if(slide.bgImage) {
                    bgLayer = `<div class="layer-bg w-full h-full flex items-center justify-center overflow-hidden"><img src="${slide.bgImage}" class="w-full h-auto object-cover" style="opacity:${slide.bgOpacity||0.3}"></div>`;
                    bgControls = `<div class="bg-control-panel"><div class="font-bold text-gray-500 mb-1">BACKGROUND</div><input type="range" min="0.1" max="1" step="0.1" value="${slide.bgOpacity||0.3}" class="w-full h-2" oninput="setBgOpacity(${i}, this.value)"><button onclick="deleteBg(${i})" class="mt-2 w-full bg-red-100 text-red-600 rounded px-2 py-1 hover:bg-red-200">HAPUS BG</button></div>`;
                }

                let freeImagesHTML = '';
                let flowImagesHTML = '';

                if(slide.images?.length) {
                    slide.images.forEach((img, imgIdx) => {
                        const layout = img.layout || 'right';
                        const isActive = (activeSelection && activeSelection.sIdx === i && activeSelection.iIdx === imgIdx);
                        const activeClass = isActive ? 'active-selection' : '';

                        const toolbarHTML = `
                            <div class="action-toolbar">
                                <button class="tool-btn ${layout==='left'?'active-mode':''}" data-action="left">L</button>
                                <button class="tool-btn ${layout==='center'?'active-mode':''}" data-action="center">C</button>
                                <button class="tool-btn ${layout==='right'?'active-mode':''}" data-action="right">R</button>
                                <button class="tool-btn ${layout==='free'?'active-mode':''}" data-action="free">Free</button>
                                <button class="tool-btn delete" data-action="delete">X</button>
                            </div>
                            <div class="resize-dot"></div>
                        `;

                        if (layout === 'free') {
                            const left = img.x !== undefined ? img.x + 'px' : '30%'; 
                            const top = img.y !== undefined ? img.y + 'px' : '20%';
                            freeImagesHTML += `
                                <div class="img-container mode-free ${activeClass}" 
                                     data-sidx="${i}" data-iidx="${imgIdx}"
                                     style="width:${img.width}; left:${left}; top:${top};">
                                    <img src="${img.url}" class="w-full rounded shadow-lg border-2 ${th.border} pointer-events-none">
                                    ${toolbarHTML}
                                </div>
                            `;
                        } else {
                            flowImagesHTML += `
                                <div class="img-container mode-${layout} ${activeClass}" 
                                     data-sidx="${i}" data-iidx="${imgIdx}"
                                     style="width:${img.width};">
                                    <img src="${img.url}" class="w-full rounded shadow-lg border-2 ${th.border} pointer-events-none">
                                    ${toolbarHTML}
                                </div>
                            `;
                        }
                    });
                }

                let content = '';
                const baseClass = `font-serif font-bold mb-4 ${th.text} leading-tight outline-none pointer-auto relative z-20`;
                
                // Determine slide style (Safe attribute quoting)
                // We use double quotes for the attribute value: style="..."
                // We use single quotes for URL strings in CSS: url('...')
                // We replaced single quotes in SVG data with %27 to prevent conflicts
                const slideStyleAttr = th.customStyle ? `style="${th.customStyle}"` : '';
                const slideBgClass = th.customStyle ? '' : th.bg;

                if(slide.type === 'title') {
                    content = `<div class="layer-content w-full px-16 relative ${align}">
                        ${flowImagesHTML}
                        <h1 class="text-5xl ${baseClass}" contenteditable="true" oninput="updateData(${i},'title',this.innerText)">${slide.title}</h1>
                        <div class="h-1.5 w-24 ${th.deco} mb-6 rounded-full inline-block"></div>
                        <p class="text-2xl italic opacity-90 outline-none ${th.text} pointer-auto relative z-20" contenteditable="true" oninput="updateData(${i},'subtitle',this.innerText)">${slide.subtitle||''}</p>
                        <p class="mt-8 font-bold uppercase text-sm tracking-widest outline-none ${th.text} pointer-auto relative z-20" contenteditable="true" oninput="updateData(${i},'speaker',this.innerText)">${slide.speaker||'Pembicara'}</p>
                        ${freeImagesHTML}
                    </div>`;
                } else if(slide.type === 'content') {
                    const pts = (slide.points||[]).map((p, pIdx) => `
                        <li class="flex items-start gap-3 mb-3 group pointer-auto relative z-20">
                            <span class="w-2 h-2 mt-2.5 rounded-full ${th.deco} flex-shrink-0"></span>
                            <span class="flex-1 text-lg outline-none leading-relaxed" contenteditable="true" oninput="updateData(${i},'points',this.innerText,${pIdx})">${p}</span>
                            <button onclick="removeBulletPoint(${i},${pIdx})" class="delete-point-btn">√ó</button>
                        </li>
                    `).join('');
                    
                    content = `
                        <div class="layer-content w-full px-20 py-12 block">
                            <div class="border-b-2 ${th.border} pb-4 mb-4 opacity-90 ${align} pointer-auto relative z-20">
                                <h2 class="text-3xl ${baseClass}" contenteditable="true" oninput="updateData(${i},'title',this.innerText)">${slide.title}</h2>
                            </div>
                            
                            <div class="w-full text-left relative z-20">
                                ${flowImagesHTML}
                                <ul class="font-light ${th.text} ${align} block">${pts}</ul>
                            </div>
                            
                            <div class="mt-4 ${align} pointer-auto clear-both relative z-20 flex gap-2 ${align === 'text-center' ? 'justify-center' : ''} ${align === 'text-right' ? 'justify-end' : ''}">
                                <button onclick="addBulletPoint(${i})" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded cursor-pointer transition shadow-sm border border-gray-200">+ Poin</button>
                                <button onclick="addAiBulletPoint(${i}, this)" class="text-sm px-3 py-1 bg-gradient-to-r from-emerald-100 to-emerald-200 hover:from-emerald-200 hover:to-emerald-300 text-emerald-800 rounded cursor-pointer flex items-center gap-1 transition shadow-sm border border-emerald-300">
                                    <span>‚ú®</span> AI Poin
                                </button>
                            </div>
                            ${freeImagesHTML}
                        </div>`;
                } else {
                    content = `<div class="layer-content w-full px-12 text-center relative z-20">
                        ${flowImagesHTML}
                        <h2 class="${baseClass} text-4xl" contenteditable="true" oninput="updateData(${i},'title',this.innerText)">${slide.title}</h2>
                        <p class="text-xl mt-6 ${th.text} outline-none pointer-auto relative z-20" contenteditable="true" oninput="updateData(${i},'subtitle',this.innerText)">${slide.subtitle||''}</p>
                        ${freeImagesHTML}
                    </div>`;
                }

                return `
                <div class="slide-wrapper relative w-full max-w-4xl flex-shrink-0 group">
                    <div class="slide-toolbar absolute top-4 -right-16 flex flex-col gap-2 z-50 pointer-auto">
                        <button onclick="moveSlide(${i},-1)" class="sidebar-btn" title="Naik">‚Üë</button>
                        <button onclick="moveSlide(${i},1)" class="sidebar-btn" title="Turun">‚Üì</button>
                        <div class="h-px bg-gray-300 mx-2"></div>
                        <button onclick="addSlide(${i})" class="sidebar-btn text-emerald-600" title="Tambah">+</button>
                        <button onclick="uploadImg(${i})" class="sidebar-btn text-blue-600" title="Gambar">IMG</button>
                        <button onclick="uploadBg(${i})" class="sidebar-btn text-purple-600" title="Background">BG</button>
                        <div class="h-px bg-gray-300 mx-2"></div>
                        <button onclick="setTextAlign(${i},'text-left')" class="sidebar-btn">L</button>
                        <button onclick="setTextAlign(${i},'text-center')" class="sidebar-btn">C</button>
                        <button onclick="setTextAlign(${i},'text-right')" class="sidebar-btn">R</button>
                        <div class="h-px bg-gray-300 mx-2"></div>
                        <button onclick="deleteSlide(${i})" class="sidebar-btn danger" title="Hapus">üóëÔ∏è</button>
                        ${bgControls}
                    </div>
                    <div class="slide w-full slide-aspect relative overflow-y-auto custom-scrollbar rounded-xl shadow-2xl border border-gray-200 ${slideBgClass} flex flex-col justify-center px-12 py-8 ${align}" ${slideStyleAttr}>
                        ${bgLayer}
                        <div class="absolute top-0 left-0 h-full w-3 ${th.deco} z-10"></div>
                        ${content}
                    </div>
                </div>`;
            }).join('');
        }

        function uploadImg(idx) {
            currentUploadIdx = idx;
            document.getElementById('imageUploader').click();
        }
        
        function handleImageUpload(e) {
            if(!e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                if(!slidesData[currentUploadIdx].images) slidesData[currentUploadIdx].images = [];
                slidesData[currentUploadIdx].images.push({ 
                    url: ev.target.result, 
                    width: '300px', 
                    layout: 'right', 
                    x: 200, y: 150
                });
                activeSelection = { sIdx: currentUploadIdx, iIdx: slidesData[currentUploadIdx].images.length - 1 };
                document.getElementById('imageUploader').value = '';
                renderSlides(slidesData);
                saveWork(); // Simpan setelah upload
            };
            reader.readAsDataURL(e.target.files[0]);
        }
        
        function uploadBg(idx) { currentBgUploadIdx = idx; document.getElementById('bgUploader').click(); }
        function handleBgUpload(e) { if(!e.target.files[0]) return; const reader = new FileReader(); reader.onload = (ev) => { slidesData[currentBgUploadIdx].bgImage = ev.target.result; slidesData[currentBgUploadIdx].bgOpacity = 0.3; slidesData[currentBgUploadIdx].bgWidth = '100%'; document.getElementById('bgUploader').value = ''; renderSlides(slidesData); saveWork(); }; reader.readAsDataURL(e.target.files[0]); }
        function setBgOpacity(idx, val) { slidesData[idx].bgOpacity = val; renderSlides(slidesData); saveWork(); } 
        function deleteBg(idx) { delete slidesData[idx].bgImage; renderSlides(slidesData); saveWork(); }
        function setTextAlign(idx, align) { slidesData[idx].align = align; renderSlides(slidesData); saveWork(); }
        function updateData(idx, key, val, subIdx=null) { 
            if(subIdx !== null) slidesData[idx].points[subIdx] = val; 
            else slidesData[idx][key] = val;
            debounceSave(); // Simpan dengan delay untuk edit teks
        }
        function moveSlide(idx, dir) { const newIdx = idx + dir; if(newIdx >= 0 && newIdx < slidesData.length) { [slidesData[idx], slidesData[newIdx]] = [slidesData[newIdx], slidesData[idx]]; renderSlides(slidesData); saveWork(); } }
        function addSlide(idx) { slidesData.splice(idx+1, 0, {type: 'content', title: 'Slide Baru', points: ['Klik untuk edit teks']}); renderSlides(slidesData); saveWork(); }
        function deleteSlide(idx) { if(confirm('Hapus slide ini?')) { slidesData.splice(idx, 1); renderSlides(slidesData); saveWork(); } }
        function addBulletPoint(idx) { if(!slidesData[idx].points) slidesData[idx].points = []; slidesData[idx].points.push("Poin baru"); renderSlides(slidesData); saveWork(); }
        function removeBulletPoint(idx, ptIdx) { if(slidesData[idx].points) { slidesData[idx].points.splice(ptIdx, 1); renderSlides(slidesData); saveWork(); } }
        function cleanText(str) { if (!str) return ""; return str.replace(/\*\*/g, "").replace(/\*/g, "").replace(/^[\-\*]\s+/, "").trim(); }

        // --- NEW AI BULLET POINT FUNCTION ---
        async function addAiBulletPoint(idx, btn) {
            const userKey = getApiKey();
            if(!userKey) { alert("Wajib mengisi API Key Google Gemini terlebih dahulu di menu sebelah kiri untuk menggunakan fitur ini."); return; }
            
            const slide = slidesData[idx];
            const originalText = btn.innerHTML;
            
            // Set Loading State
            btn.innerHTML = `<svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Mikir...`;
            btn.disabled = true;

            try {
                // Construct Context-Aware Prompt
                const prompt = `Context: A presentation slide about "${slide.title}". 
                Existing bullet points: ${JSON.stringify(slide.points)}. 
                Task: Generate exactly ONE new, relevant, short bullet point (max 15 words) that fits the context and flow. 
                Tone: Match the existing points. Language: Indonesian. 
                Output: Just the plain text of the bullet point, no markdown, no bullets.`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error?.message || "API Error");
                }
                
                const data = await res.json();
                let newPoint = data.candidates[0].content.parts[0].text.trim();
                
                // Cleanup if AI adds a dash or dot at start
                newPoint = newPoint.replace(/^[\-\*‚Ä¢]\s*/, '').replace(/^"\s*/, '').replace(/"\s*$/, '');

                if(!slidesData[idx].points) slidesData[idx].points = [];
                slidesData[idx].points.push(newPoint);
                renderSlides(slidesData);
                saveWork();

            } catch(e) {
                console.error(e);
                alert("Gagal membuat poin AI. " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function generateSlides() {
            const topic = document.getElementById('topicInput').value;
            const speaker = document.getElementById('speakerInput').value;
            const count = document.getElementById('slideCountInput').value;
            const tone = document.getElementById('toneInput').value;
            const userKey = getApiKey();
            
            if(!userKey) { alert("Wajib mengisi API Key Google Gemini terlebih dahulu di menu sebelah kiri."); return; }
            if(!topic) { alert("Mohon isi topik presentasi terlebih dahulu."); return; }
            
            toggleLoader(true);
            try {
                slidesData = await fetchAI(topic, speaker, count, tone, userKey);
                renderSlides(slidesData);
                saveWork(); // Simpan hasil generate
                document.getElementById('downloadBtn').disabled = false;
            } catch(e) {
                console.error("AI Error:", e);
                alert("Gagal menghubungi AI. Pastikan API Key valid dan koneksi internet stabil.\n\nError: " + e.message);
                document.getElementById('downloadBtn').disabled = true;
            } finally { toggleLoader(false); }
        }
        function toggleLoader(show) { document.getElementById('loader').classList.toggle('hidden', !show); }
        
        async function fetchAI(topic, speaker, count, tone, userKey) {
            let toneInstruction = "Use formal Indonesian.";
            if(tone === 'khidmat') toneInstruction = "Use poetic, reflective, soft language (muhasabah style).";
            if(tone === 'semangat') toneInstruction = "Use energetic, motivational, strong language.";
            if(tone === 'santai') toneInstruction = "Use casual, trendy, Gen-Z friendly language.";
            if(tone === 'ceria') toneInstruction = "Use simple, storytelling language for kids.";

            const prompt = `Create ${count} slides about "${topic}" by "${speaker}". Tone: ${toneInstruction}. JSON Array only. No Markdown. Schema: [{type:"title|content|outro", title:"", subtitle:"", speaker:"", points:[""]}]. Language: Indonesian.`;
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.error?.message || "Gagal mengakses API Google Gemini");
            }

            const data = await res.json();
            const txt = data.candidates[0].content.parts[0].text;
            let jsonData = JSON.parse(txt.substring(txt.indexOf('['), txt.lastIndexOf(']')+1));
            return jsonData.map(slide => ({
                ...slide,
                title: cleanText(slide.title),
                subtitle: cleanText(slide.subtitle),
                speaker: cleanText(slide.speaker) || speaker,
                points: slide.points ? slide.points.map(p => cleanText(p)) : []
            }));
        }

        async function downloadPDF() {
            const btn = document.getElementById('downloadBtn');
            btn.innerHTML = "Memproses..."; btn.disabled = true;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'l', unit: 'px', hotfixes: ['px_scaling'] });
            doc.deletePage(1);
            const slides = document.querySelectorAll('.slide');
            for(const slide of slides) {
                const clone = slide.cloneNode(true);
                // FIX FONT SIZE WYSIWYG: Set width ke 896px agar sama dengan preview (max-w-4xl)
                clone.style.width = '896px'; 
                clone.style.height = '504px'; // 16:9 ratio of 896
                clone.style.position = 'fixed'; clone.style.top = '0'; clone.style.left = '0'; clone.style.zIndex = '-9999';
                
                // Remove selection state
                clone.querySelectorAll('.img-container').forEach(el => {
                    el.classList.remove('active-selection');
                });

                clone.querySelectorAll('.action-toolbar, .resize-dot, .slide-toolbar, button, .bg-control-panel').forEach(el => el.remove());
                document.body.appendChild(clone);
                try {
                    const canvas = await html2canvas(clone, { scale: 3, useCORS: true });
                    const img = canvas.toDataURL('image/jpeg', 0.9);
                    doc.addPage([canvas.width, canvas.height], 'l');
                    doc.addImage(img, 'JPEG', 0, 0, canvas.width, canvas.height);
                } catch(e) {}
                document.body.removeChild(clone);
            }
            doc.save("Presentasi.pdf");
            btn.innerHTML = "Ekspor PDF"; btn.disabled = false;
        }

        const textToolbar = document.getElementById('textToolbar');
        let lastValidRange = null;
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            if (textToolbar.contains(document.activeElement)) return;
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                let parent = range.commonAncestorContainer.parentElement;
                let insideSlide = false;
                while (parent) {
                    if (parent.classList && parent.classList.contains('slide')) { insideSlide = true; break; }
                    parent = parent.parentElement;
                }
                if (insideSlide) {
                    lastValidRange = range.cloneRange(); 
                    const rect = range.getBoundingClientRect();
                    showToolbar(rect);
                    return;
                }
            }
            hideToolbar();
        });
        function showToolbar(rect) { textToolbar.style.display = 'flex'; textToolbar.style.top = `${rect.top - 10}px`; textToolbar.style.left = `${rect.left + (rect.width / 2)}px`; textToolbar.style.transform = `translate(-50%, -100%)`; }
        function hideToolbar() { textToolbar.style.display = 'none'; }
        function execCmd(command, value = null) { if (lastValidRange) { const selection = window.getSelection(); selection.removeAllRanges(); selection.addRange(lastValidRange); } document.execCommand(command, false, value); }
    </script>
</body>
</html>
